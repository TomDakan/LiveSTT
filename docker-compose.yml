services:
  nats:
    image: nats:2.10-alpine
    container_name: nats
    command: "-js -sd /data/nats"
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - ./data/nats:/data/nats
    networks:
      - internal_overlay

  api-gateway:
    build:
      context: ./services/api-gateway
    container_name: api-gateway
    ports:
      - "8000:8000"
    environment:
      - NATS_URL=nats://nats:4222
    volumes:
      - ./data/db:/data/db
    networks:
      - internal_overlay
    depends_on:
      - nats

  audio-producer:
    build:
      context: ./services/audio-producer
      dockerfile: Dockerfile.mock
    container_name: audio-producer
    environment:
      - NATS_URL=nats://nats:4222
    networks:
      - internal_overlay
    depends_on:
      - nats

  stt-provider:
    build: ./services/stt-provider
    container_name: stt-provider
    restart: unless-stopped
    environment:
      - NATS_URL=nats://nats:4222
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
    networks:
      - internal_overlay
    depends_on:
      - nats

  identifier:
    build: ./services/identifier
    container_name: identifier
    environment:
      - NATS_URL=nats://nats:4222
    volumes:
      - ./data/lancedb:/data/lancedb
    networks:
      - internal_overlay
    depends_on:
      - nats

  identity-manager:
    build: ./services/identity-manager
    container_name: identity-manager
    environment:
      - NATS_URL=nats://nats:4222
    networks:
      - internal_overlay
    depends_on:
      - nats

networks:
  internal_overlay:
    driver: bridge

secrets:
  deepgram_key:
    file: ./secrets/deepgram_key.txt
