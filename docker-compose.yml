services:
  nats:
    image: nats:2.10-alpine
    container_name: nats
    command: "-js -sd /data/nats"
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - ./data/nats:/data/nats
    networks:
      - internal_overlay

  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    container_name: api-gateway
    ports:
      - "8000:8000"
    environment:
      - NATS_URL=nats://nats:4222
    volumes:
      - ./data/db:/data/db
    networks:
      - internal_overlay
    depends_on:
      - nats

  audio-producer:
    build:
      context: .
      dockerfile: services/audio-producer/Dockerfile
    container_name: audio-producer
    environment:
      - NATS_URL=nats://nats:4222
      - AUDIO_FILE=/data/test_audio.wav
    volumes:
      - ./tests/data:/data
    networks:
      - internal_overlay
    depends_on:
      - nats

  stt-provider:
    build:
      context: .
      dockerfile: services/stt-provider/Dockerfile
    container_name: stt-provider
    restart: unless-stopped
    environment:
      - NATS_URL=nats://nats:4222
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
    networks:
      - internal_overlay
    depends_on:
      - nats

#   identifier:
#     build:
#       context: .
#       dockerfile: services/identifier/Dockerfile
#     container_name: identifier
#     environment:
#       - NATS_URL=nats://nats:4222
#     volumes:
#       - ./data/lancedb:/data/lancedb
#     networks:
#       - internal_overlay
#     depends_on:
#       - nats

#   identity-manager:
#     build:
#       context: .
#       dockerfile: services/identity-manager/Dockerfile
#     container_name: identity-manager
#     environment:
#       - NATS_URL=nats://nats:4222
#     networks:
#       - internal_overlay
#     depends_on:
#       - nats

networks:
  internal_overlay:
    driver: bridge


