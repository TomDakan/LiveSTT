name: Release

on:
    workflow_run:
        workflows: ["CI"]
        types:
            - completed
        branches:
            - main

# Required for semantic-release to push tags/commits and PyPI OIDC
permissions:
    contents: write # Allow tagging and pushing changes (like CHANGELOG.md)
    id-token: write # Allow OIDC token generation for PyPI

jobs:
    release:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        # Configure PyPI OIDC publishing environment (if needed)
        environment:
            name: pypi
            url: https://pypi.org/p/live-stt

        steps:
            - uses: actions/checkout@v4
              with:
                  # Fetch all history so semantic-release can analyze commits
                  fetch-depth: 0
                  # Fetch all tags so semantic-release can start from the correct version
                  fetch-tags: true
                  # Use a token with write permissions to push tags/changelog updates

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  version: "latest"

            - name: Install system dependencies
              run: sudo apt-get update && sudo apt-get install -y libasound2-dev

            - name: Install dependencies (including semantic-release)
              run: uv sync

            # Configure git user for semantic-release commits (e.g., updating changelog)
            - name: Configure Git User
              run: |

                  git config user.name "local-dev"
                  git config user.email "local-dev@example.com"

            - name: Run Semantic Release
              # Bumps version, updates changelog, and tags the release (skips publish)
              run: uv run semantic-release version
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
